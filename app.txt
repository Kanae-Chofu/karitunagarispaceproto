import streamlit as st
import sqlite3
import random
import time

# â± è‡ªå‹•æ›´æ–°ï¼ˆ3ç§’ã”ã¨ï¼‰
if "last_refresh" not in st.session_state:
    st.session_state.last_refresh = time.time()
elif time.time() - st.session_state.last_refresh > 3:
    st.session_state.last_refresh = time.time()
    st.rerun()

# ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å›ºå®š
st.markdown("""
<style>
body, .stApp { background-color: #000000; color: #FFFFFF; }
div[data-testid="stHeader"] { background-color: #000000; }
div[data-testid="stToolbar"] { display: none; }
input, textarea { background-color: #1F2F54 !important; color:#FFFFFF !important; }
button { background-color: #426AB3 !important; color:#FFFFFF !important; border: none !important; }
</style>
""", unsafe_allow_html=True)

# è©±é¡Œã‚«ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
topics = {
    "çŒ«": ["çŒ«æ´¾ï¼ŸçŠ¬æ´¾ï¼Ÿ", "é£¼ã£ã¦ã‚‹çŒ«ã®åå‰ã¯ï¼Ÿ", "çŒ«ã®ä»•è‰ã§å¥½ããªã‚‚ã®ã¯ï¼Ÿ"],
    "è¨€è‘‰": ["å¥½ããªè¨€è‘‰ã‚ã‚‹ï¼Ÿ", "åº§å³ã®éŠ˜ã£ã¦ã‚ã‚‹ï¼Ÿ", "è¨€è‘‰ã«æ•‘ã‚ã‚ŒãŸã“ã¨ã‚ã‚‹ï¼Ÿ"]
}

# DBåˆæœŸåŒ–
def init_db():
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users (
                    kari_id TEXT PRIMARY KEY,
                    password TEXT)''')
    c.execute('''CREATE TABLE IF NOT EXISTS messages (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    kari_id TEXT,
                    partner_id TEXT,
                    message TEXT,
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP)''')
    try:
        c.execute("ALTER TABLE messages ADD COLUMN topic_theme TEXT")
    except sqlite3.OperationalError:
        pass
    c.execute('''CREATE TABLE IF NOT EXISTS friend_requests (
                    from_id TEXT,
                    to_id TEXT,
                    status TEXT DEFAULT 'pending',
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP)''')
    c.execute('''CREATE TABLE IF NOT EXISTS friends (
                    user TEXT,
                    friend TEXT,
                    UNIQUE(user, friend))''')
    conn.commit()
    conn.close()

init_db()

# DBæ“ä½œé–¢æ•°
def register_user(kari_id, password):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute("SELECT * FROM users WHERE kari_id=?", (kari_id,))
    if c.fetchone():
        conn.close()
        return False
    c.execute("INSERT INTO users (kari_id, password) VALUES (?, ?)", (kari_id, password))
    conn.commit()
    conn.close()
    return True

def login_user(kari_id, password):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute("SELECT * FROM users WHERE kari_id=? AND password=?", (kari_id, password))
    result = c.fetchone()
    conn.close()
    return result is not None

def save_message(kari_id, partner_id, message, theme=None):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    if theme:
        c.execute("INSERT INTO messages (kari_id, partner_id, message, topic_theme) VALUES (?, ?, ?, ?)",
                  (kari_id, partner_id, message, theme))
    else:
        c.execute("INSERT INTO messages (kari_id, partner_id, message) VALUES (?, ?, ?)",
                  (kari_id, partner_id, message))
    conn.commit()
    conn.close()

def get_messages(kari_id, partner_id):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute('''SELECT kari_id, message FROM messages 
                 WHERE (kari_id=? AND partner_id=?) OR (kari_id=? AND partner_id=?) 
                 ORDER BY timestamp''',
              (kari_id, partner_id, partner_id, kari_id))
    messages = c.fetchall()
    conn.close()
    return messages

def get_shared_theme(kari_id, partner_id):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute('''SELECT topic_theme FROM messages 
                 WHERE ((kari_id=? AND partner_id=?) OR (kari_id=? AND partner_id=?)) 
                 AND topic_theme IS NOT NULL 
                 ORDER BY timestamp LIMIT 1''',
              (kari_id, partner_id, partner_id, kari_id))
    result = c.fetchone()
    conn.close()
    return result[0] if result else None

def send_friend_request(from_id, to_id):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute("SELECT * FROM friend_requests WHERE from_id=? AND to_id=?", (from_id, to_id))
    if c.fetchone():
        conn.close()
        return False
    c.execute("INSERT INTO friend_requests (from_id, to_id) VALUES (?, ?)", (from_id, to_id))
    conn.commit()
    conn.close()
    return True

def get_received_requests(my_id):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute("SELECT from_id FROM friend_requests WHERE to_id=? AND status='pending'", (my_id,))
    requests = c.fetchall()
    conn.close()
    return [r[0] for r in requests]

def approve_friend_request(my_id, from_id):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute("UPDATE friend_requests SET status='approved' WHERE from_id=? AND to_id=?", (from_id, my_id))
    c.execute("INSERT OR IGNORE INTO friends (user, friend) VALUES (?, ?)", (my_id, from_id))
    c.execute("INSERT OR IGNORE INTO friends (user, friend) VALUES (?, ?)", (from_id, my_id))
    conn.commit()
    conn.close()

def get_friends(my_id):
    conn = sqlite3.connect("chat.db")
    c = conn.cursor()
    c.execute("SELECT friend FROM friends WHERE user=?", (my_id,))
    friends = c.fetchall()
    conn.close()
    return [f[0] for f in friends]

# UIé–‹å§‹
st.set_page_config(page_title="ä»®ã¤ãªãŒã‚Šã‚¹ãƒšãƒ¼ã‚¹", layout="centered")
st.title("ä»®ã¤ãªãŒã‚Šã‚¹ãƒšãƒ¼ã‚¹")

# ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
if "kari_id" in st.session_state:
    st.write(f"ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š `{st.session_state.kari_id}`")

    partner_input = st.text_input("è©±ã—ãŸã„ç›¸æ‰‹ã®ä»®IDã‚’å…¥åŠ›", st.session_state.get("partner_id", ""))
    if partner_input:
        st.session_state.partner_id = partner_input

    partner = st.session_state.get("partner_id", "")
    if partner:
        st.write(f"ç›¸æ‰‹: `{partner}`")

        shared_theme = get_shared_theme(st.session_state.kari_id, partner)
        if shared_theme:
            theme = shared_theme
        else:
            if "selected_theme" not in st.session_state:
                st.session_state.theme_choices = random.sample(list(topics.keys()), 2)
                chosen = st.radio("è©±ã—ãŸã„ãƒ†ãƒ¼ãƒã‚’é¸ã‚“ã§ãã ã•ã„", st.session_state.theme_choices)
                if st.button("ã“ã®ãƒ†ãƒ¼ãƒã§è©±ã™"):
                    st.session_state.selected_theme = chosen
                    st.session_state.card_index = 0
                    st.rerun()
                st.stop()
            theme = st.session_state.selected_theme

        card_index = st.session_state.get("card_index", 0)
        st.markdown(f" è©±é¡Œã‚«ãƒ¼ãƒ‰: **{topics[theme][card_index]}**")
        if st.button("æ¬¡ã®è©±é¡Œã‚«ãƒ¼ãƒ‰"):
            st.session_state.card_index = (card_index + 1) % len(topics[theme])
            st.rerun()

        messages = get_messages(st.session_state.kari_id, partner)
        for sender, msg in messages:
            align = "right" if sender == st.session_state.kari_id else "left"
            bg = "#1F2F54" if align == "right" else "#426AB3"
            st.markdown(
                f"""
                <div style='text-align: {align}; margin: 5px 0;'>
                    <span style='background-color:{bg}; color:#FFFFFF; padding:8px 12px; border-radius:10px; display:inline-block; max-width:80%;'>
                        {msg}
                    </span>
                </div>
                """,
                unsafe_allow_html=True
            )

        new_message = st.chat_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›")
        if new_message:
            theme_to_save = get_shared_theme(st.session_state.kari_id, partner)
            if not theme_to_save and "selected_theme" in st.session_state:
                theme_to_save = st.session_state.selected_theme
            save_message(st.session_state.kari_id, partner, new_message, theme_to_save)
            st.rerun()

        if len(messages) >= 6:
            st.success("ã“ã®äºº